<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Vesla ERP</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            position: relative;
        }

        .header h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        .nav-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .nav-card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            text-decoration: none;
            color: #333;
            transition: all 0.3s ease;
            border-left: 5px solid #667eea;
        }

        .nav-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 50px rgba(0,0,0,0.15);
        }

        .nav-card h2 {
            font-size: 1.5em;
            margin-bottom: 10px;
            color: #667eea;
        }

        .nav-card p {
            color: #666;
            line-height: 1.6;
        }

        .nav-card .icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-card h3 {
            color: #666;
            font-size: 1em;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-card .number {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
        }

        .quick-actions {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-top: 30px;
        }

        .quick-actions h2 {
            color: #333;
            margin-bottom: 20px;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .btn {
            padding: 15px 25px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: #764ba2;
            transform: scale(1.05);
        }

        .btn-secondary {
            background: #48bb78;
        }

        .btn-secondary:hover {
            background: #38a169;
        }

        .btn-danger {
            background: #f56565;
        }

        .btn-danger:hover {
            background: #e53e3e;
        }

        .api-docs {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-top: 30px;
        }

        .api-docs h2 {
            color: #333;
            margin-bottom: 20px;
        }

        .api-endpoint {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .api-endpoint code {
            color: #667eea;
            font-weight: bold;
        }

        .api-endpoint p {
            color: #666;
            margin-top: 5px;
            font-size: 0.9em;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
    </style>
</head>
<body>
    <div id="dashboardContainer" class="container" style="display: none;">
        <div class="header">
            <h1>üéØ Admin Dashboard</h1>
            <p>Manage users, view analytics, and track issues - Vesla ERP System</p>
            <button id="logoutBtn" class="btn btn-danger" style="position: absolute; top: 20px; right: 20px;">Logout</button>
        </div>

        <div class="nav-grid">
            <a href="/dashboards/admin/users" class="nav-card">
                <div class="icon">üë•</div>
                <h2>User Management</h2>
                <p>Create, update, and manage user accounts. Assign roles and permissions.</p>
            </a>

            <a href="/dashboards/admin/dashboard" class="nav-card">
                <div class="icon">üìä</div>
                <h2>Dashboard Analytics</h2>
                <p>View comprehensive system statistics and performance metrics.</p>
            </a>

            <a href="/dashboards/admin/audit-logs" class="nav-card">
                <div class="icon">üìù</div>
                <h2>Audit Logs</h2>
                <p>Track all system activities, user actions, and security events.</p>
            </a>

            <a href="/dashboards/admin/issues" class="nav-card">
                <div class="icon">üêõ</div>
                <h2>Issue Tracker</h2>
                <p>Manage bugs, feature requests, and support tickets.</p>
            </a>

            <a href="/dashboards/admin/system-health" class="nav-card">
                <div class="icon">üíö</div>
                <h2>System Health</h2>
                <p>Monitor database performance and system status.</p>
            </a>

            <a href="/dashboards/admin/reports" class="nav-card">
                <div class="icon">üìà</div>
                <h2>Reports</h2>
                <p>Generate custom reports and export data.</p>
            </a>
        </div>

        <div id="stats-container" class="stats-grid">
            <div class="stat-card">
                <h3>Loading...</h3>
                <div class="number">-</div>
            </div>
        </div>

        <div class="quick-actions">
            <h2>Quick Actions</h2>
            <div class="action-buttons">
                <button class="btn" data-action="viewUsers">üìã View All Users</button>
                <button class="btn btn-secondary" data-action="createUser">‚ûï Create New User</button>
                <button class="btn" data-action="viewStats">üìä Get Stats</button>
                <button class="btn" data-action="viewAuditLogs">üìù View Audit Logs</button>
                <button class="btn" data-action="viewIssues">üêõ View Issues</button>
                <button class="btn btn-danger" data-action="openDatabase">üóÑÔ∏è Open Database</button>
            </div>
        </div>

        <div class="api-docs">
            <h2>API Endpoints Reference</h2>

            <div class="api-endpoint">
                <code>GET /api/users</code>
                <p>List all users with pagination and filters</p>
            </div>

            <div class="api-endpoint">
                <code>POST /api/users</code>
                <p>Create a new user account</p>
            </div>

            <div class="api-endpoint">
                <code>GET /api/admin/dashboard/stats</code>
                <p>Get comprehensive dashboard statistics</p>
            </div>

            <div class="api-endpoint">
                <code>GET /api/admin/audit-logs</code>
                <p>Get paginated audit logs with filters</p>
            </div>

            <div class="api-endpoint">
                <code>GET /api/admin/issues</code>
                <p>List all issues with pagination and filters</p>
            </div>

            <div class="api-endpoint">
                <code>GET /api/admin/system/health</code>
                <p>Get system health status</p>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 40px; border-radius: 15px; max-width: 400px; width: 90%;">
            <h2 style="color: #333; margin-bottom: 20px;">Admin Login</h2>
            <div style="margin-bottom: 15px;">
                <label style="display: block; color: #666; margin-bottom: 5px;">Email:</label>
                <input type="email" id="loginEmail" value="admin@vesla.com" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1em;">
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; color: #666; margin-bottom: 5px;">Password:</label>
                <input type="password" id="loginPassword" value="admin123" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1em;">
            </div>
            <div id="loginError" style="color: #e53e3e; margin-bottom: 15px; display: none;"></div>
            <button id="loginBtn" class="btn" style="width: 100%; margin-bottom: 10px;">Login</button>
        </div>
    </div>

    <!-- Create User Modal -->
    <div id="createUserModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 40px; border-radius: 15px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: #333; margin: 0;">Create New User</h2>
                <button id="closeCreateUserBtn" style="background: none; border: none; font-size: 1.5em; cursor: pointer; color: #666;">&times;</button>
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: block; color: #666; margin-bottom: 5px;">Email: *</label>
                <input type="email" id="newUserEmail" placeholder="user@example.com" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1em;">
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: block; color: #666; margin-bottom: 5px;">Password: *</label>
                <input type="password" id="newUserPassword" placeholder="Strong password" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1em;">
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: block; color: #666; margin-bottom: 5px;">First Name: *</label>
                <input type="text" id="newUserFirstName" placeholder="John" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1em;">
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: block; color: #666; margin-bottom: 5px;">Last Name: *</label>
                <input type="text" id="newUserLastName" placeholder="Doe" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1em;">
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; color: #666; margin-bottom: 5px;">Role: *</label>
                <select id="newUserRole" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1em;">
                    <option value="VIEWER">Viewer (Read-only)</option>
                    <option value="ACCOUNTANT">Accountant (Can create transactions)</option>
                    <option value="MANAGER">Manager (Can manage operations)</option>
                    <option value="ADMIN">Admin (Full access)</option>
                </select>
            </div>

            <div id="createUserError" style="color: #e53e3e; margin-bottom: 15px; display: none;"></div>
            <div id="createUserSuccess" style="color: #48bb78; margin-bottom: 15px; display: none;"></div>

            <button id="submitCreateUserBtn" class="btn" style="width: 100%;">Create User</button>
        </div>
    </div>

    <script>
        // Check if logged in on load
        function checkAuth() {
            console.log('Checking authentication...');
            const token = localStorage.getItem('admin_token');
            console.log('Token exists:', !!token);

            if (!token) {
                console.log('No token found, showing login modal');
                showLoginModal();
                hideDashboard();
            } else {
                console.log('Token found, showing dashboard');
                hideLoginModal();
                showDashboard();
                loadStats();
            }
        }

        function showLoginModal() {
            document.getElementById('loginModal').style.display = 'flex';
        }

        function hideLoginModal() {
            document.getElementById('loginModal').style.display = 'none';
        }

        function showDashboard() {
            document.getElementById('dashboardContainer').style.display = 'block';
        }

        function hideDashboard() {
            document.getElementById('dashboardContainer').style.display = 'none';
        }

        function showCreateUserModal() {
            document.getElementById('createUserModal').style.display = 'flex';
        }

        function closeCreateUserModal() {
            document.getElementById('createUserModal').style.display = 'none';
            // Clear form
            document.getElementById('newUserEmail').value = '';
            document.getElementById('newUserPassword').value = '';
            document.getElementById('newUserFirstName').value = '';
            document.getElementById('newUserLastName').value = '';
            document.getElementById('newUserRole').value = 'VIEWER';
            document.getElementById('createUserError').style.display = 'none';
            document.getElementById('createUserSuccess').style.display = 'none';
        }

        async function handleLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');
            const loginBtn = document.getElementById('loginBtn');

            console.log('Login attempt with:', { email, password: '***' });

            if (!email || !password) {
                errorDiv.textContent = 'Please enter email and password';
                errorDiv.style.display = 'block';
                return;
            }

            // Show loading state
            loginBtn.textContent = 'Logging in...';
            loginBtn.disabled = true;
            errorDiv.style.display = 'none';

            try {
                console.log('Sending login request to /api/auth/login...');

                const response = await fetch('http://localhost:3000/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                console.log('Response status:', response.status);

                const data = await response.json();
                console.log('Response data:', data);

                if (!response.ok) {
                    console.error('Login failed:', data);
                    errorDiv.textContent = data.message || 'Login failed';
                    errorDiv.style.display = 'block';
                    loginBtn.textContent = 'Login';
                    loginBtn.disabled = false;
                    return;
                }

                console.log('Login successful!');

                // Store token
                localStorage.setItem('admin_token', data.data.token);
                localStorage.setItem('admin_user', JSON.stringify(data.data.user));

                hideLoginModal();
                showDashboard();
                loadStats();
                loginBtn.textContent = 'Login';
                loginBtn.disabled = false;
            } catch (error) {
                console.error('Login error:', error);
                errorDiv.textContent = 'Network error: Unable to connect to server';
                errorDiv.style.display = 'block';
                loginBtn.textContent = 'Login';
                loginBtn.disabled = false;
            }
        }

        async function handleCreateUser() {
            const email = document.getElementById('newUserEmail').value;
            const password = document.getElementById('newUserPassword').value;
            const firstName = document.getElementById('newUserFirstName').value;
            const lastName = document.getElementById('newUserLastName').value;
            const role = document.getElementById('newUserRole').value;

            const errorDiv = document.getElementById('createUserError');
            const successDiv = document.getElementById('createUserSuccess');

            // Clear previous messages
            errorDiv.style.display = 'none';
            successDiv.style.display = 'none';

            // Validate
            if (!email || !password || !firstName || !lastName) {
                errorDiv.textContent = 'All fields are required';
                errorDiv.style.display = 'block';
                return;
            }

            const token = localStorage.getItem('admin_token');

            try {
                const response = await fetch('http://localhost:3000/api/users', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ email, password, firstName, lastName, role })
                });

                const data = await response.json();

                if (!response.ok) {
                    errorDiv.textContent = data.message || 'Failed to create user';
                    errorDiv.style.display = 'block';
                    return;
                }

                successDiv.textContent = `‚úÖ User created successfully! Email: ${email}`;
                successDiv.style.display = 'block';

                // Clear form
                setTimeout(() => {
                    closeCreateUserModal();
                }, 2000);
            } catch (error) {
                errorDiv.textContent = 'Network error. Please try again.';
                errorDiv.style.display = 'block';
            }
        }

        function logout() {
            localStorage.removeItem('admin_token');
            localStorage.removeItem('admin_user');
            hideDashboard();
            showLoginModal();
            // Clear the stats
            document.getElementById('stats-container').innerHTML = `
                <div class="stat-card">
                    <h3>Loading...</h3>
                    <div class="number">-</div>
                </div>
            `;
        }

        // Load dashboard stats
        async function loadStats() {
            try {
                const token = localStorage.getItem('admin_token');
                if (!token) {
                    showLoginModal();
                    return;
                }

                const response = await fetch('http://localhost:3000/api/admin/dashboard/stats', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        showLoginModal();
                        return;
                    }
                    throw new Error('Failed to load stats');
                }

                const data = await response.json();
                displayStats(data.data);
            } catch (error) {
                console.error('Error loading stats:', error);
                document.getElementById('stats-container').innerHTML = `
                    <div class="stat-card">
                        <h3>Error</h3>
                        <p style="color: #e53e3e;">Failed to load statistics. Please check your authentication.</p>
                    </div>
                `;
            }
        }

        function displayStats(stats) {
            const statsHTML = `
                <div class="stat-card">
                    <h3>Total Users</h3>
                    <div class="number">${stats.users.total}</div>
                </div>
                <div class="stat-card">
                    <h3>Active Users</h3>
                    <div class="number">${stats.users.active}</div>
                </div>
                <div class="stat-card">
                    <h3>Total Companies</h3>
                    <div class="number">${stats.companies.total}</div>
                </div>
                <div class="stat-card">
                    <h3>Total Customers</h3>
                    <div class="number">${stats.customers.total}</div>
                </div>
                <div class="stat-card">
                    <h3>Total Transactions</h3>
                    <div class="number">${stats.accounting.totalTransactions}</div>
                </div>
                <div class="stat-card">
                    <h3>Total Invoices</h3>
                    <div class="number">${stats.accounting.totalInvoices}</div>
                </div>
                <div class="stat-card">
                    <h3>Total Bookings</h3>
                    <div class="number">${stats.rental.totalBookings}</div>
                </div>
                <div class="stat-card">
                    <h3>Audit Logs Today</h3>
                    <div class="number">${stats.audit.todayLogs}</div>
                </div>
            `;
            document.getElementById('stats-container').innerHTML = statsHTML;
        }

        function openAPI(endpoint) {
            const token = localStorage.getItem('admin_token');
            if (!token) {
                showLoginModal();
                return;
            }

            const url = `http://localhost:3000${endpoint}`;
            console.log(`Opening API endpoint: ${url} with token`);

            // Open in new tab with auth header (browsers won't send custom headers, but we can view raw JSON)
            window.open(url, '_blank');
        }

        function createUser() {
            const token = localStorage.getItem('admin_token');
            if (!token) {
                showLoginModal();
                return;
            }

            showCreateUserModal();
        }

        function openPrismaStudio() {
            console.log('To open Prisma Studio, run: cd web-erp-app/backend && npx prisma studio');

            // Show a nicer modal instead of alert
            const message = document.createElement('div');
            message.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 2000; max-width: 500px;';

            const closeBtn = document.createElement('button');
            closeBtn.className = 'btn';
            closeBtn.style.cssText = 'margin-top: 15px; width: 100%;';
            closeBtn.textContent = 'Close';
            closeBtn.addEventListener('click', () => message.remove());

            message.innerHTML = `
                <h3 style="margin-bottom: 15px; color: #333;">Open Prisma Studio</h3>
                <p style="margin-bottom: 15px; color: #666;">To open Prisma Studio, run these commands in your terminal:</p>
                <pre style="background: #f7fafc; padding: 15px; border-radius: 8px; overflow-x: auto;"><code>cd web-erp-app/backend
npx prisma studio</code></pre>
            `;
            message.appendChild(closeBtn);
            document.body.appendChild(message);
        }

        // Event Listeners - Setup after DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            // Login button
            document.getElementById('loginBtn').addEventListener('click', handleLogin);

            // Login on Enter key
            document.getElementById('loginPassword').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleLogin();
            });

            // Logout button
            document.getElementById('logoutBtn').addEventListener('click', logout);

            // Create user modal buttons
            document.getElementById('closeCreateUserBtn').addEventListener('click', closeCreateUserModal);
            document.getElementById('submitCreateUserBtn').addEventListener('click', handleCreateUser);

            // Quick action buttons with data-action attributes
            document.querySelectorAll('[data-action]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const action = e.target.getAttribute('data-action');
                    switch(action) {
                        case 'viewUsers':
                            openAPI('/api/users');
                            break;
                        case 'createUser':
                            createUser();
                            break;
                        case 'viewStats':
                            openAPI('/api/admin/dashboard/stats');
                            break;
                        case 'viewAuditLogs':
                            openAPI('/api/admin/audit-logs');
                            break;
                        case 'viewIssues':
                            openAPI('/api/admin/issues');
                            break;
                        case 'openDatabase':
                            openPrismaStudio();
                            break;
                    }
                });
            });
        });

        // Check auth on load
        checkAuth();
    </script>
</body>
</html>
