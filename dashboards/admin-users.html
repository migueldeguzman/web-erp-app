<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management - Vesla Admin</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .header h1 {
            color: #333;
            font-size: 32px;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .filters-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .filters-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-size: 12px;
            color: #666;
            font-weight: 600;
        }

        .filter-group input,
        .filter-group select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            background: white;
        }

        .filter-group input:focus,
        .filter-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .toggle-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .toggle-btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .toggle-btn.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-color: #667eea;
        }

        .table-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead th {
            text-align: left;
            padding: 15px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-weight: 600;
            font-size: 14px;
            white-space: nowrap;
        }

        thead th:first-child {
            border-radius: 8px 0 0 0;
        }

        thead th:last-child {
            border-radius: 0 8px 0 0;
        }

        tbody tr {
            border-bottom: 1px solid #e0e0e0;
            transition: background 0.3s ease;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        tbody td {
            padding: 15px;
            font-size: 14px;
            color: #333;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .role-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            background: #e7f1ff;
            color: #004085;
        }

        .role-admin {
            background: #fff3cd;
            color: #856404;
        }

        .role-manager {
            background: #d1ecf1;
            color: #0c5460;
        }

        .actions-cell {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
        }

        .pagination-info {
            color: #666;
            font-size: 14px;
        }

        .pagination-controls {
            display: flex;
            gap: 10px;
        }

        .page-btn {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .page-btn:hover:not(:disabled) {
            background: #f8f9fa;
            border-color: #667eea;
        }

        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .page-btn.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-color: #667eea;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #333;
            font-size: 24px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .modal-close {
            float: right;
            font-size: 28px;
            font-weight: bold;
            color: #999;
            cursor: pointer;
            line-height: 20px;
        }

        .modal-close:hover {
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 30px;
        }

        .activity-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px;
        }

        .activity-item {
            padding: 10px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 13px;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-action {
            font-weight: 600;
            color: #667eea;
        }

        .activity-time {
            color: #999;
            font-size: 11px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            animation: slideDown 0.3s ease;
        }

        .message-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state svg {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes slideDown {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 24px;
            }

            .filters-row {
                flex-direction: column;
            }

            .filter-group {
                width: 100%;
            }

            .table-container {
                padding: 15px;
            }

            .actions-cell {
                flex-direction: column;
            }

            .pagination {
                flex-direction: column;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>User Management</h1>
            <div class="header-actions">
                <a href="admin.html" class="btn btn-secondary">‚Üê Back to Dashboard</a>
                <button id="createUserBtn" class="btn btn-primary">+ Create New User</button>
            </div>
        </div>

        <!-- Message Container -->
        <div id="messageContainer"></div>

        <!-- Filters Section -->
        <div class="filters-section">
            <div class="filters-row">
                <div class="filter-group">
                    <label>Search</label>
                    <input type="text" id="searchInput" placeholder="Search by email or name...">
                </div>
                <div class="filter-group">
                    <label>Role</label>
                    <select id="roleFilter">
                        <option value="">All Roles</option>
                        <option value="ADMIN">Admin</option>
                        <option value="ACCOUNTANT">Accountant</option>
                        <option value="MANAGER">Manager</option>
                        <option value="VIEWER">Viewer</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Status</label>
                    <div class="toggle-group">
                        <button class="toggle-btn active" data-status="">All</button>
                        <button class="toggle-btn" data-status="active">Active</button>
                        <button class="toggle-btn" data-status="inactive">Inactive</button>
                    </div>
                </div>
                <div class="filter-group">
                    <label>&nbsp;</label>
                    <button id="applyFilters" class="btn btn-primary">Apply Filters</button>
                </div>
            </div>
        </div>

        <!-- Users Table -->
        <div class="table-container">
            <div id="tableContent">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Loading users...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Create/Edit User Modal -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-close" onclick="closeUserModal()">&times;</span>
                <h2 id="modalTitle">Create New User</h2>
            </div>
            <form id="userForm">
                <input type="hidden" id="userId">
                <div class="form-group">
                    <label for="userEmail">Email *</label>
                    <input type="email" id="userEmail" required>
                </div>
                <div class="form-group">
                    <label for="userName">Name *</label>
                    <input type="text" id="userName" required>
                </div>
                <div class="form-group">
                    <label for="userPassword">Password <span id="passwordHint">(leave empty to keep current)</span></label>
                    <input type="password" id="userPassword">
                </div>
                <div class="form-group">
                    <label for="userRole">Role *</label>
                    <select id="userRole" required>
                        <option value="VIEWER">Viewer</option>
                        <option value="ACCOUNTANT">Accountant</option>
                        <option value="MANAGER">Manager</option>
                        <option value="ADMIN">Admin</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeUserModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save User</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Activity Modal -->
    <div id="activityModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-close" onclick="closeActivityModal()">&times;</span>
                <h2>User Activity Log</h2>
            </div>
            <div id="activityContent">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Loading activity...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE_URL = 'http://localhost:3000/api';
        let currentPage = 1;
        let totalPages = 1;
        let users = [];

        // Check authentication
        function checkAuth() {
            const token = localStorage.getItem('admin_token');
            if (!token) {
                window.location.href = 'login.html';
                return false;
            }
            return token;
        }

        // Show message
        function showMessage(message, type = 'info') {
            const container = document.getElementById('messageContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message message-${type}`;
            messageDiv.textContent = message;
            container.innerHTML = '';
            container.appendChild(messageDiv);

            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }

        // Format date
        function formatDate(dateString) {
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            return new Date(dateString).toLocaleDateString('en-US', options);
        }

        // Format datetime
        function formatDateTime(dateString) {
            const options = {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            return new Date(dateString).toLocaleString('en-US', options);
        }

        // Load users
        async function loadUsers(page = 1) {
            const token = checkAuth();
            if (!token) return;

            const tableContent = document.getElementById('tableContent');
            tableContent.innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Loading users...</p>
                </div>
            `;

            try {
                // Build query params
                const params = new URLSearchParams({
                    page: page.toString(),
                    limit: '10'
                });

                // Add filters
                const search = document.getElementById('searchInput').value;
                const role = document.getElementById('roleFilter').value;
                const statusBtn = document.querySelector('.toggle-btn.active');
                const status = statusBtn.dataset.status;

                if (search) params.append('search', search);
                if (role) params.append('role', role);
                if (status) params.append('status', status);

                const response = await fetch(`${API_BASE_URL}/users?${params}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.status === 401) {
                    localStorage.removeItem('admin_token');
                    window.location.href = 'login.html';
                    return;
                }

                if (!response.ok) {
                    throw new Error('Failed to load users');
                }

                const data = await response.json();
                users = data.users || [];
                currentPage = data.page || 1;
                totalPages = data.totalPages || 1;

                renderUsersTable(data);
            } catch (error) {
                console.error('Error loading users:', error);
                showMessage('Failed to load users', 'error');
                tableContent.innerHTML = `
                    <div class="empty-state">
                        <p>Failed to load users. Please try again.</p>
                    </div>
                `;
            }
        }

        // Render users table
        function renderUsersTable(data) {
            const tableContent = document.getElementById('tableContent');

            if (!data.users || data.users.length === 0) {
                tableContent.innerHTML = `
                    <div class="empty-state">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                        <h3>No users found</h3>
                        <p>Try adjusting your filters or create a new user.</p>
                    </div>
                `;
                return;
            }

            const tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Email</th>
                            <th>Name</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Created Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.users.map(user => `
                            <tr>
                                <td>${user.email}</td>
                                <td>${user.name}</td>
                                <td><span class="role-badge role-${user.role.toLowerCase()}">${user.role}</span></td>
                                <td>
                                    <span class="status-badge status-${user.isActive ? 'active' : 'inactive'}">
                                        ${user.isActive ? 'Active' : 'Inactive'}
                                    </span>
                                </td>
                                <td>${formatDate(user.createdAt)}</td>
                                <td>
                                    <div class="actions-cell">
                                        <button class="btn btn-info btn-sm" onclick="editUser('${user.id}')">Edit</button>
                                        <button class="btn btn-${user.isActive ? 'warning' : 'success'} btn-sm"
                                                onclick="${user.isActive ? 'deactivateUser' : 'reactivateUser'}('${user.id}')">
                                            ${user.isActive ? 'Deactivate' : 'Reactivate'}
                                        </button>
                                        <button class="btn btn-secondary btn-sm" onclick="viewActivity('${user.id}')">Activity</button>
                                        <button class="btn btn-danger btn-sm" onclick="deleteUser('${user.id}')">Delete</button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                <div class="pagination">
                    <div class="pagination-info">
                        Showing ${((data.page - 1) * data.limit) + 1} to ${Math.min(data.page * data.limit, data.total)} of ${data.total} users
                    </div>
                    <div class="pagination-controls">
                        <button class="page-btn" onclick="loadUsers(1)" ${data.page === 1 ? 'disabled' : ''}>First</button>
                        <button class="page-btn" onclick="loadUsers(${data.page - 1})" ${data.page === 1 ? 'disabled' : ''}>Previous</button>
                        ${generatePageButtons(data.page, data.totalPages)}
                        <button class="page-btn" onclick="loadUsers(${data.page + 1})" ${data.page === data.totalPages ? 'disabled' : ''}>Next</button>
                        <button class="page-btn" onclick="loadUsers(${data.totalPages})" ${data.page === data.totalPages ? 'disabled' : ''}>Last</button>
                    </div>
                </div>
            `;

            tableContent.innerHTML = tableHTML;
        }

        // Generate page buttons
        function generatePageButtons(currentPage, totalPages) {
            let buttons = '';
            const maxButtons = 5;
            let start = Math.max(1, currentPage - Math.floor(maxButtons / 2));
            let end = Math.min(totalPages, start + maxButtons - 1);

            if (end - start + 1 < maxButtons) {
                start = Math.max(1, end - maxButtons + 1);
            }

            for (let i = start; i <= end; i++) {
                buttons += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="loadUsers(${i})">${i}</button>`;
            }

            return buttons;
        }

        // Open user modal
        function openUserModal(isEdit = false, userId = null) {
            const modal = document.getElementById('userModal');
            const modalTitle = document.getElementById('modalTitle');
            const form = document.getElementById('userForm');
            const passwordHint = document.getElementById('passwordHint');

            form.reset();
            document.getElementById('userId').value = userId || '';

            if (isEdit && userId) {
                modalTitle.textContent = 'Edit User';
                passwordHint.style.display = 'inline';
                document.getElementById('userPassword').removeAttribute('required');

                // Load user data
                const user = users.find(u => u.id === userId);
                if (user) {
                    document.getElementById('userEmail').value = user.email;
                    document.getElementById('userName').value = user.name;
                    document.getElementById('userRole').value = user.role;
                }
            } else {
                modalTitle.textContent = 'Create New User';
                passwordHint.style.display = 'none';
                document.getElementById('userPassword').setAttribute('required', 'required');
            }

            modal.classList.add('active');
        }

        // Close user modal
        function closeUserModal() {
            const modal = document.getElementById('userModal');
            modal.classList.remove('active');
        }

        // Edit user
        function editUser(userId) {
            openUserModal(true, userId);
        }

        // Save user
        async function saveUser(event) {
            event.preventDefault();

            const token = checkAuth();
            if (!token) return;

            const userId = document.getElementById('userId').value;
            const isEdit = !!userId;

            const userData = {
                email: document.getElementById('userEmail').value,
                name: document.getElementById('userName').value,
                role: document.getElementById('userRole').value
            };

            const password = document.getElementById('userPassword').value;
            if (password || !isEdit) {
                userData.password = password;
            }

            try {
                const url = isEdit ? `${API_BASE_URL}/users/${userId}` : `${API_BASE_URL}/users`;
                const method = isEdit ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userData)
                });

                if (response.status === 401) {
                    localStorage.removeItem('admin_token');
                    window.location.href = 'login.html';
                    return;
                }

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Failed to save user');
                }

                showMessage(`User ${isEdit ? 'updated' : 'created'} successfully`, 'success');
                closeUserModal();
                loadUsers(currentPage);
            } catch (error) {
                console.error('Error saving user:', error);
                showMessage(error.message || 'Failed to save user', 'error');
            }
        }

        // Deactivate user
        async function deactivateUser(userId) {
            if (!confirm('Are you sure you want to deactivate this user?')) return;

            const token = checkAuth();
            if (!token) return;

            try {
                const response = await fetch(`${API_BASE_URL}/users/${userId}/deactivate`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.status === 401) {
                    localStorage.removeItem('admin_token');
                    window.location.href = 'login.html';
                    return;
                }

                if (!response.ok) {
                    throw new Error('Failed to deactivate user');
                }

                showMessage('User deactivated successfully', 'success');
                loadUsers(currentPage);
            } catch (error) {
                console.error('Error deactivating user:', error);
                showMessage('Failed to deactivate user', 'error');
            }
        }

        // Reactivate user
        async function reactivateUser(userId) {
            const token = checkAuth();
            if (!token) return;

            try {
                const response = await fetch(`${API_BASE_URL}/users/${userId}/reactivate`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.status === 401) {
                    localStorage.removeItem('admin_token');
                    window.location.href = 'login.html';
                    return;
                }

                if (!response.ok) {
                    throw new Error('Failed to reactivate user');
                }

                showMessage('User reactivated successfully', 'success');
                loadUsers(currentPage);
            } catch (error) {
                console.error('Error reactivating user:', error);
                showMessage('Failed to reactivate user', 'error');
            }
        }

        // Delete user
        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to permanently delete this user? This action cannot be undone.')) return;

            const token = checkAuth();
            if (!token) return;

            try {
                const response = await fetch(`${API_BASE_URL}/users/${userId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.status === 401) {
                    localStorage.removeItem('admin_token');
                    window.location.href = 'login.html';
                    return;
                }

                if (!response.ok) {
                    throw new Error('Failed to delete user');
                }

                showMessage('User deleted successfully', 'success');
                loadUsers(currentPage);
            } catch (error) {
                console.error('Error deleting user:', error);
                showMessage('Failed to delete user', 'error');
            }
        }

        // View activity
        async function viewActivity(userId) {
            const token = checkAuth();
            if (!token) return;

            const modal = document.getElementById('activityModal');
            const content = document.getElementById('activityContent');

            modal.classList.add('active');
            content.innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Loading activity...</p>
                </div>
            `;

            try {
                const response = await fetch(`${API_BASE_URL}/users/${userId}/activity`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.status === 401) {
                    localStorage.removeItem('admin_token');
                    window.location.href = 'login.html';
                    return;
                }

                if (!response.ok) {
                    throw new Error('Failed to load activity');
                }

                const activities = await response.json();

                if (activities.length === 0) {
                    content.innerHTML = `
                        <div class="empty-state">
                            <p>No activity found for this user.</p>
                        </div>
                    `;
                } else {
                    content.innerHTML = `
                        <div class="activity-list">
                            ${activities.map(activity => `
                                <div class="activity-item">
                                    <div class="activity-action">${activity.action}</div>
                                    <div>${activity.entity} ${activity.entityId ? `(${activity.entityId})` : ''}</div>
                                    <div class="activity-time">${formatDateTime(activity.createdAt)}</div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading activity:', error);
                content.innerHTML = `
                    <div class="empty-state">
                        <p>Failed to load activity. Please try again.</p>
                    </div>
                `;
            }
        }

        // Close activity modal
        function closeActivityModal() {
            const modal = document.getElementById('activityModal');
            modal.classList.remove('active');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Check authentication
            if (!checkAuth()) return;

            // Load initial data
            loadUsers();

            // Setup event listeners
            document.getElementById('createUserBtn').addEventListener('click', () => openUserModal(false));
            document.getElementById('userForm').addEventListener('submit', saveUser);
            document.getElementById('applyFilters').addEventListener('click', () => loadUsers(1));

            // Search on enter
            document.getElementById('searchInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    loadUsers(1);
                }
            });

            // Status toggle buttons
            document.querySelectorAll('.toggle-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                });
            });

            // Close modals when clicking outside
            window.addEventListener('click', (event) => {
                if (event.target.classList.contains('modal')) {
                    event.target.classList.remove('active');
                }
            });
        });
    </script>
</body>
</html>